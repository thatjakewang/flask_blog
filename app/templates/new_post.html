<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>新文章 | 管理面板</title>
    <script src="https://cdn.ckeditor.com/ckeditor5/16.0.0/classic/ckeditor.js"></script>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/dashboard.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <h1>新增文章</h1>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %} {% endif %} {% endwith %}

      <form method="POST" enctype="multipart/form-data">
        {{ form.csrf_token }}

        <div class="form-group">
          <label for="title">{{ form.title.label }}</label>
          {{ form.title(class="form-control") }} {% if form.title.errors %}
          <div class="errors">
            {% for error in form.title.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="slug">{{ form.slug.label }}</label>
          {{ form.slug(class="form-control") }} {% if form.slug.errors %}
          <div class="errors">
            {% for error in form.slug.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="description">{{ form.description.label }}</label>
          {{ form.description(class="form-control") }} {% if
          form.description.errors %}
          <div class="errors">
            {% for error in form.description.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="content">內容</label>
          <textarea id="editor" name="content">
{{ form.content.data or '' }}</textarea
          >
          {% if form.content.errors %}
          <div class="errors">
            {% for error in form.content.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="tags">{{ form.tags.label }}</label>
          {{ form.tags(class="form-control") }} {% if form.tags.errors %}
          <div class="errors">
            {% for error in form.tags.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="form-group checkbox">
          {{ form.published }}
          <label for="published">{{ form.published.label }}</label>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">儲存文章</button>
          <a href="{{ url_for('dashboard.index') }}" class="btn btn-secondary"
            >取消</a
          >
        </div>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        ClassicEditor.create(document.querySelector("#editor"), {
          toolbar: [
            "heading",
            "|",
            "bold",
            "italic",
            "link",
            "bulletedList",
            "numberedList",
            "|",
            "outdent",
            "indent",
            "|",
            "blockQuote",
            "insertTable",
            "undo",
            "redo",
          ],
        })
          .then((editor) => {
            console.log("編輯器初始化成功:", editor);

            // 表單提交前將編輯器內容同步到隱藏欄位
            document
              .querySelector("form")
              .addEventListener("submit", function () {
                const editorData = editor.getData();
                // 這裡不需要額外的隱藏欄位，因為我們直接使用 name="content" 的 textarea
              });
          })
          .catch((error) => {
            console.error("編輯器初始化失敗:", error);
          });

        // 自動從標題生成 slug
        document.getElementById("title").addEventListener("blur", function () {
          const titleField = this;
          const slugField = document.getElementById("slug");

          // 只有當 slug 欄位為空時才自動生成
          if (slugField.value === "") {
            const titleValue = titleField.value;
            const slugValue = titleValue
              .toLowerCase()
              .replace(/[^a-z0-9\u4e00-\u9fa5]+/g, "-")
              .replace(/^-+|-+$/g, "");

            slugField.value = slugValue;
          }
        });
      });
    </script>
  </body>
</html>
